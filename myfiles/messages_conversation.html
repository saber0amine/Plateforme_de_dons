<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Conversation avec ' + ${otherUser.username})}"></head>
<body class="d-flex flex-column min-vh-100">
<nav th:replace="~{fragments/layout :: navbar}"></nav>

<main class="flex-grow-1 py-4">
    <div class="container">
        <div th:replace="~{fragments/layout :: alerts}"></div>

        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/messages}"><i class="bi bi-arrow-left"></i> Messages</a></li>
                <li class="breadcrumb-item active" th:text="${otherUser.username}"></li>
            </ol>
        </nav>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">
                                    <i class="bi bi-person-circle"></i>
                                    <span th:text="${otherUser.username}"></span>
                                </h5>
                                <small th:if="${annonce == null}">Conversation générale</small>
                            </div>
                            <span th:if="${annonce != null}" class="badge bg-light text-dark">
                                <i class="bi bi-tag"></i> <span th:text="${annonce.titre}"></span>
                            </span>
                        </div>
                    </div>

                    <div class="card-body p-0" style="max-height: 60vh; overflow-y: auto; background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);" id="messagesContainer">
                        <div th:if="${messages.isEmpty()}" class="text-center py-5 text-muted">
                            <i class="bi bi-chat-dots fs-1"></i>
                            <p class="mt-3">Démarrez la conversation !</p>
                        </div>

                        <div class="p-3">
                            <div th:each="msg, iterStat : ${messages}" class="mb-3"
                                 th:classappend="${msg.senderUsername != otherUser.username} ? 'text-end' : ''">
                                <div class="d-inline-block p-3 rounded-3 position-relative"
                                     style="max-width: 75%;"
                                     th:classappend="${msg.senderUsername != otherUser.username} ? 'bg-primary text-white' : 'bg-white border shadow-sm'">
                                    <p class="mb-1" th:text="${msg.content}" style="white-space: pre-line;"></p>
                                    <div class="d-flex align-items-center justify-content-end gap-1">
                                        <small th:classappend="${msg.senderUsername != otherUser.username} ? 'text-white-50' : 'text-muted'"
                                               th:text="${#temporals.format(msg.sentAt, 'dd/MM HH:mm')}"></small>
                                        <i th:if="${msg.senderUsername != otherUser.username && msg.read}"
                                           class="bi bi-check2-all text-white-50"></i>
                                        <i th:if="${msg.senderUsername != otherUser.username && !msg.read}"
                                           class="bi bi-check2 text-white-50"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer bg-white border-top">
                        <form th:action="@{/messages}" method="post" id="messageForm">
                            <input type="hidden" name="receiverId" th:value="${otherUser.id}">
                            <input type="hidden" name="annonceId" th:value="${annonce != null ? annonce.id : null}">

                            <div class="input-group">
                                <textarea class="form-control border-0" name="content" rows="2"
                                          placeholder="Votre message..." required
                                          style="resize: none;"
                                          onkeypress="if(event.keyCode==13 && !event.shiftKey){document.getElementById('messageForm').submit(); return false;}"></textarea>
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="bi bi-send-fill"></i>
                                    <span class="d-none d-md-inline ms-1">Envoyer</span>
                                </button>
                            </div>
                            <small class="text-muted">Appuyez sur Entrée pour envoyer, Shift+Entrée pour une nouvelle ligne</small>
                        </form>
                    </div>
                </div>

                <div th:if="${annonce != null}" class="card shadow mt-3">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-3">
                            <div th:if="${annonce.imageUrl != null}" style="width: 80px; height: 80px; overflow: hidden; border-radius: 8px;">
                                <img th:src="@{${annonce.imageUrl}}" alt="Image" class="w-100 h-100" style="object-fit: cover;">
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1" th:text="${annonce.titre}"></h6>
                                <p class="mb-1 small text-muted" th:text="${#strings.abbreviate(annonce.description, 100)}"></p>
                                <div class="d-flex gap-1">
                                    <span class="badge bg-secondary" th:text="${annonce.etatObjet.displayName}"></span>
                                    <span class="badge bg-info" th:text="${annonce.modeLivraison.displayName}"></span>
                                </div>
                            </div>
                            <div>
                                <a th:href="@{/annonces/{id}(id=${annonce.id})}" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-eye"></i> Voir
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/layout :: footer}"></footer>
<div th:replace="~{fragments/layout :: scripts}"></div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var container = document.getElementById('messagesContainer');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }

        var form = document.getElementById('messageForm');
        if (form) {
            form.addEventListener('submit', function() {
                setTimeout(function() {
                    if (container) {
                        container.scrollTop = container.scrollHeight;
                    }
                }, 100);
            });
        }
    });
</script>
</body>
</html>